# Ledget

<div style="text-align:center">
  <img src="media/logoicon.png" alt="Logo" width="100" height="100">
</div>

## Tech Stack

Front

- React
- React Native
- Vite
- Nx

Back

- Django
- Postgres
- Stripe (payments processing)
- Plaid (financial data agregator)
- Ory (authentication)
- Oathkeeper (access decision manager)

## Dev Environment

1. First clone the git repo:

```
git clone git@github.com:sc-mitton/Ledget.git
```

2. Run the setup script:

```
chmod 755 setup.sh && ./setup.sh
```

3. Install dev tools
   Go is optional, you only need it for developing the oathkeeper lambda authorizer

```
brew install stripe
brew install oathkeeper
brew install ory
brew install openssl
brew install ory/tap/cli
brew install --cask ngrok
brew install awscli
brew install go
brew install node
brew install python
```

4. Generate oathkeeper jwks

```
oathkeeper credentials generate --alg RS256 > ./secrets/dev_jwks.json
```

5. Get the stripe api key (should start with sk_test) from the stripe dashboard and add it to a file ./secrets/stripe_api_key and also to ./secrets/.env.stripe.dev

6. Get the webhook secret from stripe. This command will output the secret which you should add to a file ./secrets/stripe_webhook_secret.

```
stripe listen --forward-to https://localhost/hooks/stripe --skip-verify --headers "X-Forwarded-For:3.18.12.63"
```

7. Get all the necessary api keys that weren't generated by the startup script and add them to the secrets folder

Needed:

- ory_api_key
- ory_tunnel_key
- plaid_dev_api_key
- plaid_sand_api_key
- sparkpost_api_key
- stripe_dev_api_key

8. Install the front end dependencies

```
curl -fsSL https://bun.sh/install | bash
exec /bin/zsh
cd front
bun install
```

8. Run the Environment
   It's worth saving these commands somewhere, aliasing them, or saving as a workflow in warp terminal

```
docker-compose up -d --build
cd front
export NODE_ENV='development'
pm2 start nx --name web-app -- run web-app:serve &&
pm2 start nx --name webportal -- run webportal:serve
```

9. Stop the Environment

```
docker-compose down

pm2 stop web-app &&
pm2 stop webportal &&
pm2 delete all
```

10. Running the landing page dev server

```
# Make sure you're in the ./apps/landing directory
 npm start
```

## Mobile Dev Environment

```
docker-compose up -d --build
export NODE_ENV='development'
nx run mobileapp:start
```

Install XCode and Android Studio if you haven't already. For Android studio, add the Android sdk path to your $PATH variable.

You'll have to drag and drop the crt authority onto the ios simulator in order to get requests to go through when developing with https. You'll also need to go into the settings app on the emulator and set it to allow http.

For an android emulator, go to the settings > security & privacy > more security & privacy > encryption & credentials > install a certificate
You can then install the necessary CA authority to get the dev environment working. Drag and drop the CA pem file and it will appear in the downlaoded folder.

## Webhook Testing

To test ory webhooks in the dev environment, you can use this command.
Dependencies: ngrok & ory (you will need to create an ngrok account)

```
ngrok http 127.0.0.1:443 --host-header='localhost' --log=stdout > ngrok.log &
sleep 1
export NGROK_TUNNEL=$(grep "url=" ngrok.log | awk -F 'url=' '{print $2}')
ory get identity-config reverent-lewin-bqqp1o2zws --format yaml > project-configuration.yaml
sed -i '' -e 's|https.*ngrok.*hooks|'$NGROK_TUNNEL'\/hooks|g' project-configuration.yaml
ory update identity-config "$(ory list projects | grep "ledget-dev" | cut -f1)" -f project-configuration.yaml
```

Close the tunnel:

```
kill -9 $(ps aux | grep -m 1 'ngrok http' | awk '{print $2}')
rm ngrok.log
rm project-configuration.yaml
```

For working with the stripe webhook, you'll also need to use the stripe cli:

```
stripe listen --forward-to https://localhost/hooks/stripe --skip-verify --headers "X-Forwarded-For:3.18.12.63"
```

## Plaid

The username and password for the sandbox environment are user_good and pass_good respectively.

## Demo Mode

There is a demo account with dummy data from plaid's sandbox environment.
Be sure to have PLAID_ENVIRONMENT = 'sandbox' set in django settings

email: smitton.byu@gmail.com
password: LedgetDemoPassword

## Environments

There are three main environments, dev, uat, and prod. Prod is hosted on aws while dev is
run localy. Uat has yet to be developed.

## CI/CD

The CI process for the app is implimented with github actions. There are workflows for testing and building
the following components:

1. Rest API

- There are tests which run on every push and pull to the dev, uat, and main branches
- On pulls and pushes to the uat and main branches, deployments are automatically run
  after successful test runs

2. Front End

- Build the js bundles and sync them to the s3 buckets

Notes:

- Builds usually have a step to check for changes in that component before a build is done.

### Testing

#### Front End

There currently aren't any tests setup for the front end

#### Back End

The suite of unit tests for django rest framework is run on every commit to the dev, uat, and main branches

You can run the tests manually with

```
docker-compose run --rm restapi sh -c "python manage.py test"
```

Coverage for the unit tests is required to be > 90%

### Versioning
